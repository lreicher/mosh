[[extend 'layout.html']]

<style>
  [v-cloak]{
    display: none;
  }
</style>

<div class="section" id="vue-target" v-cloak>
    <div class="buttons">
        <button @click="set_add_status(true)" class="button is-primary">
            <i class="fa fa-plus fa-fw"></i>Add Event
        </button>
        <button v-if="!view_myevents" @click="set_view_myevents_status(true)" class="button is-info">
            <i class="fa fa-book fa-fw"></i>View My Events
        </button>
        <button v-else @click="set_view_myevents_status(false)" class="button is-info">
            <i class="fa fa-globe fa-fw"></i>View All Events
        </button>
    </div>

    <!-- MyEvents Page -->
    <div v-if="view_myevents" class="container">
        <div class="columns is-mobile">
            <div class="column is-three-quarters">
                <table class="table is-striped is-halfwidth">
                    <tr>
                        <th>Host</th>
                        <th>Event Name</th>
                        <th>Location</th>
                        <th>Description</th>
                        <th>Price</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Creation Date</th>
                        <th></th>
                        <th></th>
                        <th></th>
                    </tr>
                    <template v-for="e in events">
                        <tr v-if="e.created_by === user_email">
                            <td v-for="fn in ['host', 'event_name', 'location', 'description', 
                            'price', 'date', 'time']">
                                <div class="control" :class="{'is-loading': e._state[fn] === 'pending'}">
                                    <input type="text" class="input" v-model="e[fn]"
                                            :class="{'is-focused': e._state[fn] === 'edit',
                                                'is-static': e._state[fn] === 'clean'}"
                                            :readonly="e._state[fn] === 'clean'"
                                            @click="start_edit(e._idx, fn)"
                                            @blur="stop_edit(e._idx, fn)"
                                    />
                                </div>
                            </td>
                            <td>{{e.creation_date}}</td>
                                <!-- <button class="button is-primary">
                                    <i class="fa fa-pencil fa-fw"></i>Edit Event
                                </button> -->
                                <button @click="delete_event(e._idx)" class="button is-danger">
                                    <i class="fa fa-pencil fa-fw"></i>Delete Event
                                </button>
                                <button class="button is-primary">
                                    <i class="fa fa-users fa-fw"></i>View Attendees
                                </button>
                            </td>
                        </tr>
                    </template>
                </table>
            </div>
            <div class="column is-one-quarter">
                <!-- <div class="section" id="vue-target"> -->
                    <v-calendar 
                        :attributes='attributes'
                        :min-date="new Date()"
                    >
                    </v-calendar>
                <!--</div>-->
            </div>
        </div>
    </div>

    <!-- Main Feed -->
    <div v-else class="columns block is-mobile mt-3">
        <div class="column is-3">
            <div class="box">
                <h2 class="subtitle">Saved Parties</h2>
                <div v-for="e in events">
                    <div v-if="e.attending === true" class="card mb-3">
                        <div class="card-header">
                            <div class="card-header-title">{{e.event_name}}</div>
                        </div>
                        <div class="card-image">
                            <figure class="image">
                                <img src="mosh_logo.png" alt="Placeholder image">
                            </figure>
                        </div>
                        <div class="card-content">
                            <div class="content">
                                <div class="columns">
                                    <div class="column">{{e.location}}</div>
                                    <div class="column">{{e.when}}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
          </div>
        </div>
        <div class="column is-6 box">
            <div v-if="add_status">
                <div class="form">
                    <p>Let's get some details about your event.</p>
                    <div class="field">
                        <div class="control">
                            <input v-model="new_event_host" placeholder="Who's Hosting?"/>
                            <input v-model="new_event_name" placeholder="Name of the Event?"/>
                            <input v-model="new_event_location" placeholder="Where is it?"/>
                            <textarea v-model="new_event_description" placeholder="Describe the Event."></textarea>
                            <input type="number" v-model="new_event_price" placeholder="How much does it cost?"/>
                            <input type="date" v-model="new_event_date" placeholder="What date will the Event happen?"/>
                            <input type="time" v-model="new_event_time" placeholder="When during the day will it be?"/>
                        </div>
                    </div>
                    <div class="field">
                        <div class="control">
                            <input type="submit" @click="add_event" value="Post" class="button is-primary">
                            <input type="submit" @click="set_add_status(false)" value="Cancel" class="button is-warning">
                        </div>
                    </div>
                </div>
            </div>
            <div v-else>
                <h2 class="subtitle">New Events</h2>
                <div class="section pt-0 container">
                    <div v-for="e in events" class="card mb-3">
                    <div class="card-header">
                        <div class="card-header-title">{{e.event_name}}</div>
                    </div>
                    <div class="card-image">
                        <figure class="image">
                            <!-- TODO Add something here for images -->
                        </figure>
                    </div>
                    <div class="card-content">
                        <div class="content">
                            <div class="columns">
                                <div class="column">
                                    <span class="icon">
                                      <i class="fa fa-map-marker" aria-hidden="true"></i>
                                    </span>
                                    {{e.location}}
                                </div>
                                <div class="column">
                                    {{e.when}}
                                </div>
                                <div class="column">
                                    <span class="icon">
                                      <i class="fa fa-glass" aria-hidden="true"></i>
                                    </span>
                                    Substances
                                </div>
                                <div class="column">
                                    <div v-if="e.price === 0">
                                      Free
                                    </div>
                                    <div v-else>
                                      ${{e.price}}
                                    </div>
                                    <span class="icon">
                                      <i class="fa fa-ticket" aria-hidden="true"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <p class="mt-1">{{e.description}}</p>
                        <button v-if="e.attending" @click="toggle_attending(e._idx)" class="button is-primary">
                            <i class="fa fa-minus fa-fw"></i>Unattend
                        </button>
                        <button v-else @click="toggle_attending(e._idx)" class="button is-primary">
                            <i class="fa fa-plus fa-fw"></i>Attend
                        </button>
                        <button v-if="e.created_by !== user_email" @click="start_conversation(e._idx)" class="button is-primary">
                            <i class="fa fa-envelope fa-fw"></i>Start Conversation
                        </button>
                    </div>
                </div>
                </div>
            </div>
        </div>
        <div class="column is-3 box">
            <h2 class="subtitle">Messages</h2>
            <div v-for="c in conversations" class="card mb-3" > <!-- Begin message card-->
              <div @click="load_conversation(c._idx)" class="card-header"> <!--PUT @CLICK HERE FOR OPEN CONVO METHOD -->
                <!-- recipient name, depending on whether user is the host or not -->
                <div v-if="c.host_email == user_email"class="card-header-subtitle">
                    {{c.user_name}}
                </div>
                <div v-else class="card-header-subtitle">
                    {{c.host_name}}
                </div>
              </div>
            </div>

            <div v-if="open_conversation !== -1" class="modal is-active">
                <div class="modal-background"></div>
                <div class="modal-card">
                    <header class="modal-card-head">
                        <span v-if="open_conversation.host_email == user_email">
                            <p class="modal-card-title">Message With {{open_conversation.user_name}}</p>
                        </span>
                        <span v-else>
                            <p class="modal-card-title">Message With {{open_conversation.host_name}}</p>
                        </span>
                        
                    </header>
                    <section class="modal-card-body">
                        <!-- Display messages -->
                        
                        <div v-for="message in messages" class="columns is-vertical is-mobile">
                            <div v-if="message.creator_email === user_email" class="column">
                                <div class="box my-1 is-pulled-right has-background-info">
                                    {{message.message}}
                                </div>
                                <br>
                            </div>
                            <div v-else class="column">
                                <div class="box my-1 is-pulled-left">
                                    {{message.message}}
                                </div>
                                <br>
                            </div>
                            
                        </div>
                        
                    </section>
                    <footer class="modal-card-foot">
                        <div class = "form">
                            <div class = "field">
                                <div class = "control">
                                    <input v-model="add_message" class="input is-info" placeholder="Write a message"></input>
                                </div>
                            </div>
                            <div class = "field">
                                <div class = "control">
                                    <button @click = "send_message(open_conversation._idx)" class="button is-success">Send</button>
                                    <button @click = "close_conversation()" class="button">Cancel</button>
                                </div>
                            </div>
                        </div>
                        
                    </footer>
                </div>
            </div>

        </div>
    </div>

</div>


[[block page_scripts]]
<!-- Loads the index-specific js for Vue -->
<!-- 1. Link Vue Javascript -->
<script src='https://unpkg.com/vue/dist/vue.js'></script>       
<!-- 2. Link VCalendar Javascript (Plugin automatically installed) -->
<script src='https://unpkg.com/v-calendar'></script>
<!--3. Create the Vue instance-->
<script>
  let load_feed_url = "[[=XML(load_feed_url)]]";
  let add_event_url = "[[=XML(add_event_url)]]";
  let edit_event_url = "[[=XML(edit_event_url)]]";
  let delete_event_url = "[[=XML(delete_event_url)]]";
  let load_attendees_url = "[[=XML(load_attendees_url)]]";
  let set_attending_url = "[[=XML(set_attending_url)]]";
  let send_message_url = "[[=XML(send_message_url)]]";
  let load_messages_url = "[[=XML(load_messages_url)]]";
  let load_conversations_url = "[[=XML(load_conversations_url)]]";
  let start_conversation_url = "[[=XML(start_conversation_url)]]";
  let my_callback_url = "[[=XML(my_callback_url)]]";
</script>
<script src="js/index.js"></script>
[[end]]